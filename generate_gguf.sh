#!/usr/bin/env bash
set -euo pipefail

# =============================================================================
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ –∏–∑ GGUF-–º–æ–¥–µ–ª–∏ —á–µ—Ä–µ–∑ llama.cpp
# =============================================================================

# --- –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ---------------------------------------------------
DEFAULT_LLAMA_BIN="/evo/llama.cpp/build/bin/llama-cli"
DEFAULT_MODEL="/m2/skuf_9/llm.bin"
DEFAULT_OUTPUT="generated/output.txt"
DEFAULT_THREADS=$(nproc)
DEFAULT_TOKENS=512
DEFAULT_RUNS=20
DEFAULT_TEMP=0.8
DEFAULT_GPU_LAYERS=0
DEFAULT_PROMPT=""

# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö ------------------------------------------------
LLAMA_BIN="$DEFAULT_LLAMA_BIN"
MODEL="$DEFAULT_MODEL"
OUTPUT="$DEFAULT_OUTPUT"
THREADS="$DEFAULT_THREADS"
TOKENS="$DEFAULT_TOKENS"
RUNS="$DEFAULT_RUNS"
TEMP="$DEFAULT_TEMP"
GPU_LAYERS="$DEFAULT_GPU_LAYERS"
PROMPT="$DEFAULT_PROMPT"
APPEND_MODE=false

# --- –§—É–Ω–∫—Ü–∏—è –ø–æ–º–æ—â–∏ ----------------------------------------------------------
show_help() {
    cat << EOF
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–û–ü–¶–ò–ò]

–û–ø—Ü–∏–∏:
    -m, --model PATH        –ü—É—Ç—å –∫ GGUF-–º–æ–¥–µ–ª–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $DEFAULT_MODEL)
    -o, --output PATH       –§–∞–π–ª –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $DEFAULT_OUTPUT)
    -b, --binary PATH       –ü—É—Ç—å –∫ llama-cli (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $DEFAULT_LLAMA_BIN)
    -t, --threads N         –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ CPU-–ø–æ—Ç–æ–∫–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $DEFAULT_THREADS)
    -n, --tokens N          –¢–æ–∫–µ–Ω–æ–≤ –Ω–∞ –∑–∞–ø—É—Å–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $DEFAULT_TOKENS)
    -r, --runs N            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—É—Å–∫–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $DEFAULT_RUNS)
    -T, --temp FLOAT        –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ 0.0-2.0 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $DEFAULT_TEMP)
    -g, --gpu-layers N      –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ—ë–≤ –Ω–∞ GPU (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $DEFAULT_GPU_LAYERS)
    -p, --prompt TEXT       –ù–∞—á–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ø—É—Å—Ç–æ)
    -a, --append            –î–æ–ø–∏—Å—ã–≤–∞—Ç—å –≤ —Ñ–∞–π–ª –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏
    -h, --help              –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É

–ü—Ä–∏–º–µ—Ä—ã:
    $0 -m model.gguf -o output.txt -r 10 -n 256
    $0 --model model.gguf --temp 1.2 --gpu-layers 32
    $0 -p "–ñ–∏–ª-–±—ã–ª" -r 5 -T 0.9

EOF
    exit 0
}

# --- –ü–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ -------------------------------------
while [[ $# -gt 0 ]]; do
    case "$1" in
        -m|--model)
            MODEL="$2"
            shift 2
            ;;
        -o|--output)
            OUTPUT="$2"
            shift 2
            ;;
        -b|--binary)
            LLAMA_BIN="$2"
            shift 2
            ;;
        -t|--threads)
            THREADS="$2"
            shift 2
            ;;
        -n|--tokens)
            TOKENS="$2"
            shift 2
            ;;
        -r|--runs)
            RUNS="$2"
            shift 2
            ;;
        -T|--temp)
            TEMP="$2"
            shift 2
            ;;
        -g|--gpu-layers)
            GPU_LAYERS="$2"
            shift 2
            ;;
        -p|--prompt)
            PROMPT="$2"
            shift 2
            ;;
        -a|--append)
            APPEND_MODE=true
            shift
            ;;
        -h|--help)
            show_help
            ;;
        *)
            echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä: $1" >&2
            echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ -h –∏–ª–∏ --help –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏" >&2
            exit 1
            ;;
    esac
done

# --- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ----------------------------------------------------
if [[ ! -f "$LLAMA_BIN" ]]; then
    echo "‚ùå –û—à–∏–±–∫–∞: llama-cli –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: $LLAMA_BIN" >&2
    exit 1
fi

if [[ ! -x "$LLAMA_BIN" ]]; then
    echo "‚ùå –û—à–∏–±–∫–∞: $LLAMA_BIN –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º —Ñ–∞–π–ª–æ–º" >&2
    exit 1
fi

if [[ ! -f "$MODEL" ]]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $MODEL" >&2
    exit 1
fi

if [[ $THREADS -lt 1 ]]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å >= 1" >&2
    exit 1
fi

if [[ $TOKENS -lt 1 ]]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å >= 1" >&2
    exit 1
fi

if [[ $RUNS -lt 1 ]]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—É—Å–∫–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å >= 1" >&2
    exit 1
fi

# --- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ ----------------------------------------------
OUTPUT_DIR=$(dirname "$OUTPUT")
if [[ ! -d "$OUTPUT_DIR" ]]; then
    echo "üìÅ –°–æ–∑–¥–∞—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: $OUTPUT_DIR" >&2
    mkdir -p "$OUTPUT_DIR"
fi

if [[ "$APPEND_MODE" == false ]]; then
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    rm -f "$OUTPUT"
    echo "üóëÔ∏è  –í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª –æ—á–∏—â–µ–Ω" >&2
else
    echo "‚ûï –†–µ–∂–∏–º –¥–æ–ø–∏—Å—ã–≤–∞–Ω–∏—è –≤ —Ñ–∞–π–ª" >&2
fi

# --- –í—ã–≤–æ–¥ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ------------------------------------------------------
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" >&2
echo "üöÄ –ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞" >&2
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" >&2
echo "  –ú–æ–¥–µ–ª—å:       $MODEL" >&2
echo "  –í—ã—Ö–æ–¥:        $OUTPUT" >&2
echo "  –¢–æ–∫–µ–Ω–æ–≤:      $TOKENS" >&2
echo "  –ó–∞–ø—É—Å–∫–æ–≤:     $RUNS" >&2
echo "  –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:  $TEMP" >&2
echo "  CPU –ø–æ—Ç–æ–∫–æ–≤:  $THREADS" >&2
echo "  GPU —Å–ª–æ—ë–≤:    $GPU_LAYERS" >&2
echo "  –ü—Ä–æ–º–ø—Ç:       ${PROMPT:-<–ø—É—Å—Ç–æ>}" >&2
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" >&2
echo "" >&2

# --- –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ -------------------------------------------------
START_TIME=$(date +%s)

for i in $(seq 1 "$RUNS"); do
    echo "ü¶ô  –ó–∞–ø—É—Å–∫ $i / $RUNS‚Ä¶" >&2

    # –ó–∞–ø—É—Å–∫ llama.cpp —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    "$LLAMA_BIN" \
        --model "$MODEL" \
        --threads "$THREADS" \
        --n-predict "$TOKENS" \
        --n-gpu-layers "$GPU_LAYERS" \
        --temp "$TEMP" \
        --prompt "$PROMPT" \
        --no-display-prompt \
        >> "$OUTPUT"

    # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏
    echo -e "\n" >> "$OUTPUT"
done

# --- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è ---------------------------------------------------
END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))
LINES_COUNT=$(wc -l < "$OUTPUT")
CHARS_COUNT=$(wc -c < "$OUTPUT")

echo "" >&2
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" >&2
echo "‚úÖ  –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!" >&2
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" >&2
echo "  –§–∞–π–ª:         $OUTPUT" >&2
echo "  –°—Ç—Ä–æ–∫:        $LINES_COUNT" >&2
echo "  –°–∏–º–≤–æ–ª–æ–≤:     $CHARS_COUNT" >&2
echo "  –í—Ä–µ–º—è:        ${ELAPSED}s" >&2
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" >&2
